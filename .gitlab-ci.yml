build-and-deploy:
  stage: build
  script:
    # Debug info before build
    - echo "Starting build process..."
    - df -h
    - pwd
    - ls -la

    # Build the book based on branch with proper error handling
    - |
      if [ "$CI_COMMIT_BRANCH" == "release" ]; then
        echo "Building production version"
        teachbooks build --publish book/ > >(tee stdout.log) 2> >(tee stderr.log >&2)
        BUILD_EXIT_CODE=$?
        HOOK_URL="https://mude.citg.tudelft.nl/hooks/book-deploy-production"
      else
        echo "Building draft version"
        teachbooks build book/ > >(tee stdout.log) 2> >(tee stderr.log >&2)
        BUILD_EXIT_CODE=$?
        HOOK_URL="https://mude.citg.tudelft.nl/hooks/book-deploy-draft"
      fi
      
      # Check if build was successful
      if [ $BUILD_EXIT_CODE -ne 0 ]; then
        echo "Build failed with exit code $BUILD_EXIT_CODE"
        cat stderr.log
        exit $BUILD_EXIT_CODE
      fi

    # Get build size and handle deployment
    - echo "Calculating build size..."
    - SIZE=$(du -sk book/_build/html | cut -f1)
    - echo "Build size is ${SIZE}KB"
    - echo $CI_JOB_ID > build_job_id.txt
    
    # Create minimal artifact set if build is large
    - |
      if [ "$SIZE" -gt 153600 ]; then  # 150MB in KB
        echo "Build size too large, creating minimal artifact set"
        mkdir -p minimal_artifact
        cp build_job_id.txt minimal_artifact/
        cp stdout.log minimal_artifact/
        cp stderr.log minimal_artifact/
      fi

    # Notify webhook
    - |
      curl -X POST "${HOOK_URL}" \
        -H "Content-Type: application/json" \
        -H "X-Gitlab-Token: glpat-m4CzsDqHnXNn3Pf5Whyd" \
        -d "{\"object_kind\":\"pipeline\",\"object_attributes\":{\"status\":\"success\",\"ref\":\"${CI_COMMIT_BRANCH}\"},\"build_job_id\":$CI_JOB_ID}"
      CURL_EXIT_CODE=$?
      
      if [ $CURL_EXIT_CODE -ne 0 ]; then
        echo "Webhook notification failed with exit code $CURL_EXIT_CODE"
        exit $CURL_EXIT_CODE
      fi

    # Debug info after build
    - echo "Directory sizes after build:"
    - du -sh book/_build/*
    - echo "Build and deploy completed"

  artifacts:
    when: on_success
    paths:
      - stdout.log
      - stderr.log
      - build_job_id.txt
      - minimal_artifact/
      - book/_build/html/**
    exclude:
      - book/_build/jupyter_execute/**
      - "**/*.ipynb"
      - "**/__pycache__"
      - "**/*.pyc"
      - book/_build/.doctrees
      - book/_build/jupyter_cache
      - book/_build/.jupyter_cache
      - "**/*.pickle"
      - "**/*.doctree"
      - "**/*.ipynb_checkpoints"
    expire_in: 1 week

  environment:
    name: $CI_COMMIT_BRANCH
    url: $CI_ENVIRONMENT_URL

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      variables:
        CI_ENVIRONMENT_URL: "https://mude.citg.tudelft.nl/2024/book/draft"
    - if: $CI_COMMIT_BRANCH == "release"
      variables:
        CI_ENVIRONMENT_URL: "https://mude.citg.tudelft.nl/2024/book"